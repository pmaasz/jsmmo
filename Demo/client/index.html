<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />

    <title>jsmmo demo</title>

    <style>
        body {
            text-align: center;
            background-color: black;
        }
        canvas{
            border: 1px solid #05cc00;
        }
    </style>
</head>
<body>
<canvas></canvas>

<script>
    /** Global Variables*/

    //direction codes
    const DIRECTION = {
        IDLE: 0,
        UP: 1,
        DOWN: 2,
        LEFT: 3,
        RIGHT: 4
    };

    const itemColor = '#05cc00';
    const backgroundColor = '#000000';
    const score = 5;
    let mode;

    /** Game objects */

    // The ball object (The cube that bounces back and forth)
    let Ball = {
        new: function (incrementedSpeed) {
            return {
                width: 18,
                height: 18,
                x: (this.canvas.width / 2) - 9,
                y: (this.canvas.height / 2) - 9,
                moveX: DIRECTION.IDLE,
                moveY: DIRECTION.IDLE,
                speed: incrementedSpeed || 9
            };
        }
    };

    // The Player object (The two lines that move up and down)
    let Player = {
        new: function (side) {
            return {
                width: 18,
                height: 70,
                x: side === 'left' ? 150 : this.canvas.width - 150,
                y: (this.canvas.height / 2) - 35,
                score: 0,
                move: DIRECTION.IDLE,
                speed: 10
            };
        }
    };

    /** the actual game */
    let Game = {
        initialize: function () {
            this.canvas = document.querySelector('canvas');
            this.context = this.canvas.getContext('2d');

            this.canvas.width = 1400;
            this.canvas.height = 1000;

            this.canvas.style.width = (this.canvas.width / 2) + 'px';
            this.canvas.style.height = (this.canvas.height / 2) + 'px';

            this.playerOne = Player.new.call(this, 'left');
            this.playerTwo = Player.new.call(this, 'right');
            this.ball = Ball.new.call(this);

            this.running = this.over = false;
            this.turn = this.playerTwo;
            this.timer = 0;
            this.color = backgroundColor;

            Pong.menu();
            Pong.listen();
        },

        menu: function () {
            // Draw all the Pong objects in their current state
            Pong.draw();

            // Change the canvas font size and color
            this.context.font = '35px Courier New';
            this.context.fillStyle = this.color;

            // Draw the rectangle behind the 'Press any key to begin' text.
            this.context.fillRect(
                this.canvas.width / 2 - 350,
                this.canvas.height / 2 - 48,
                700,
                100
            );

            // Change the canvas color;
            this.context.fillStyle = itemColor;

            // Draw the 'press any key to begin' text
            this.context.fillText("Choose an opponent: [1] Computer, [2] Local, [3] Online.",
                this.canvas.width / 2,
                this.canvas.height / 3
            );
        },

        endScreen: function (text) {
            // Change the canvas font size and color
            Pong.context.font = '50px Courier New';
            Pong.context.fillStyle = this.color;

            // Draw the rectangle behind the 'Press any key to begin' text.
            Pong.context.fillRect(
                Pong.canvas.width / 2 - 350,
                Pong.canvas.height / 2 - 48,
                700,
                100
            );

            // Change the canvas color;
            Pong.context.fillStyle = itemColor;

            // Draw the end game menu text ('Game Over' and 'Winner')
            Pong.context.fillText(text,
                Pong.canvas.width / 2,
                Pong.canvas.height / 2 + 15
            );

            Pong.running = Pong.over = false;

            //reset all the values and increment the round number.
            this.playerOne.score = this.playerTwo.score = 0;

            setTimeout(function () {
                let Pong = Object.assign({}, Game);
                Pong.initialize();
            }, 3000);
        },

        // Update all objects (move the player, ball, increment the score, etc.)
        update: function () {
            if (!this.over) {
                Pong.updateBall(this.ball, this.playerOne, this.playerTwo);
                Pong.updatePlayer(this.playerOne);

                Pong.updatePlayerBounds(this.playerOne);
                Pong.updatePlayerBounds(this.playerTwo);

                switch (mode) {
                    case 1:
                        Pong.updateAI(this.playerTwo);
                        break;
                    case 2:
                        Pong.updatePlayer(this.playerTwo);
                        break;
                    case 3:
                        Pong.updateOpponent();
                        break;
                }

                Pong.updatePlayerBallCollision(this.playerOne, DIRECTION.RIGHT);
                Pong.updatePlayerBallCollision(this.playerTwo, DIRECTION.LEFT);
            }

            Pong.determineWinner(this.playerOne.score, this.playerTwo.score);
        },

        updateBall: function (ball, playerOne, playerTwo) {
            // If the ball collides with the bound limits - correct the x and y coordinates.
            if (ball.x <= 0) {
                Pong._resetTurn.call(this, playerTwo, playerOne);
            }

            if (ball.x >= this.canvas.width - ball.width) {
                Pong._resetTurn.call(this, playerOne, playerTwo);
            }

            if (ball.y <= 0) {
                ball.moveY = DIRECTION.DOWN;
            }

            if (ball.y >= this.canvas.height - ball.height) {
                ball.moveY = DIRECTION.UP;
            }

            // Move ball in intended direction based on moveY and moveX values
            if (ball.moveY === DIRECTION.UP) {
                ball.y -= (ball.speed / 1.5);
            } else if (ball.moveY === DIRECTION.DOWN) {
                ball.y += (ball.speed / 1.5);
            }

            if (ball.moveX === DIRECTION.LEFT) {
                ball.x -= ball.speed;
            } else if (ball.moveX === DIRECTION.RIGHT) {
                ball.x += ball.speed;
            }

            /*
            On new serve (start of each turn) move the ball to the correct side and randomize the direction to add
            some challenge.
            */
            if (Pong._turnDelayIsOver.call(this) && this.turn) {
                ball.moveX = this.turn === playerOne ? DIRECTION.LEFT : DIRECTION.RIGHT;
                ball.moveY = [DIRECTION.UP, DIRECTION.DOWN][Math.round(Math.random())];
                ball.y = Math.floor(Math.random() * this.canvas.height - 200) + 200;
                this.turn = null;
            }
        },

        // updates players from keyboard input
        updatePlayer: function (player) {
            // Move playerOne if they player.move value was updated by a keyboard event
            if (player.move === DIRECTION.UP) {
                player.y -= player.speed;
            } else if (player.move === DIRECTION.DOWN) {
                player.y += player.speed;
            }
        },

        // updates computer playerTwo
        updateAI: function (player) {
            // Handle playerTwo (AI) UP and DOWN movement
            let slow = 2;
            let fast = 8 / 1.5;

            if (player.y > this.ball.y - (player.height / 2)) {
                if (this.ball.moveX === DIRECTION.RIGHT) {
                    player.y -= fast;
                } else {
                    player.y -= slow;
                }
            }

            if (player.y < this.ball.y - (player.height / 2)) {
                if (this.ball.moveX === DIRECTION.RIGHT) {
                    player.y += fast;
                } else {
                    player.y += slow;
                }
            }
        },

        // updates online opponent
        updateOpponent: function (){

        },

        updatePlayerBounds: function (player) {
            // If the player collides with the bound limits, update the x and y coords.
            if (player.y <= 0) {
                player.y = 0;
            } else if (player.y >= (this.canvas.height - player.height)) {
                player.y = (this.canvas.height - player.height);
            }
        },

        updatePlayerBallCollision: function (player, direction) {
            if (this.ball.x - this.ball.width <= player.x && this.ball.x >= player.x - player.width &&
                this.ball.y <= player.y + player.height && this.ball.y + this.ball.height >= player.y) {
                this.ball.x = (player.x + this.ball.width);
                this.ball.moveX = direction;
            }
        },

        determineWinner: function (playerOneScore, playerTwoScore) {
            // Check to see if the player won the Game.
            if(playerOneScore === score) {
                // end Game
                Pong.over = true;

                setTimeout(function () {
                        Pong.endScreen('Player one wins!');
                    }, 1000
                );
            }

            if(playerTwoScore === score) {
                // end Game
                Pong.over = true;

                setTimeout(function () {
                        Pong.endScreen('Player two wins!');
                    }, 1000
                );
            }
        },

        // Draw the objects to the canvas element
        draw: function () {
            // Clear the Canvas
            this.context.clearRect(
                0,
                0,
                this.canvas.width,
                this.canvas.height
            );

            // Set the fill style to black
            this.context.fillStyle = this.color;

            // Draw the background
            this.context.fillRect(
                0,
                0,
                this.canvas.width,
                this.canvas.height
            );

            // Set the fill style to white (For the players and the ball)
            this.context.fillStyle = itemColor;

            // Draw the Player
            this.context.fillRect(
                this.playerOne.x,
                this.playerOne.y,
                this.playerOne.width,
                this.playerOne.height
            );

            // Draw the Players
            this.context.fillRect(
                this.playerTwo.x,
                this.playerTwo.y,
                this.playerTwo.width,
                this.playerTwo.height
            );

            // Draw the Ball
            if (Pong._turnDelayIsOver.call(this)) {
                this.context.fillRect(
                    this.ball.x,
                    this.ball.y,
                    this.ball.width,
                    this.ball.height
                );
            }

            // Draw the net (Line in the middle)
            this.context.beginPath();
            this.context.setLineDash([7, 15]);
            this.context.moveTo((this.canvas.width / 2), this.canvas.height - 140);
            this.context.lineTo((this.canvas.width / 2), 140);
            this.context.lineWidth = 10;
            this.context.strokeStyle = itemColor;
            this.context.stroke();

            // Set the default canvas font and align it to the center
            this.context.font = '100px Courier New';
            this.context.textAlign = 'center';

            // Draw the players score (left)
            this.context.fillText(
                this.playerOne.score.toString(),
                (this.canvas.width / 2) - 300,
                200
            );

            // Draw the playerTwo score (right)
            this.context.fillText(
                this.playerTwo.score.toString(),
                (this.canvas.width / 2) + 300,
                200
            );
        },

        loop: function () {
            Pong.update();
            Pong.draw();

            // If the game is not over, draw the next frame.
            if (!Pong.over) {
                requestAnimationFrame(Pong.loop);
            }
        },

        listen: function () {
            document.addEventListener('keydown', function (event) {
                // Handle the 'Press any key to begin' function and start the game.
                // @todo maybe use switch case
                if (Pong.running === false && (event.key === "1" || event.key === "2" || event.key === "3")) {
                    if(event.key === "1") {
                        mode = 1;
                    } else if (event.key === "2") {
                        mode = 2;
                    } else if (event.key === "3") {
                        mode = 3
                    }

                    Pong.running = true;
                    window.requestAnimationFrame(Pong.loop);
                }

                /** Player One */
                // Handle up arrow and w key events
                if (event.key === 'w') {
                    Pong.playerOne.move = DIRECTION.UP;
                }

                // Handle down arrow and s key events
                if (event.key === 's') {
                    Pong.playerOne.move = DIRECTION.DOWN;
                }

                /** Player Two local multiplayer */
                if(mode === 2) {
                    // Handle up arrow and w key events
                    if (event.key === 'ArrowUp') {
                        Pong.playerTwo.move = DIRECTION.UP;
                    }

                    // Handle down arrow and s key events
                    if (event.key === 'ArrowDown') {
                        Pong.playerTwo.move = DIRECTION.DOWN;
                    }
                }
            });

            // Stop the player from moving when there are no keys being pressed.
            document.addEventListener('keyup', function (event) {
                if (event.key === 'w' || event.key === 's') {
                    Pong.playerOne.move = DIRECTION.IDLE;
                }

                // local multiplayer
                if(mode === 2 && (event.key === 'ArrowDown' || event.key === 'ArrowUp')) {
                    Pong.playerTwo.move = DIRECTION.IDLE;
                }
            });
        },

        // Reset the ball location, the player turns and set a delay before the next Game begins.
        _resetTurn: function(victor, loser) {
            this.ball = Ball.new.call(this, this.ball.speed);
            this.turn = loser;
            this.timer = (new Date()).getTime();

            victor.score++;
        },

        // Wait for a delay to have passed after each turn.
        _turnDelayIsOver: function() {
            return ((new Date()).getTime() - this.timer >= 1000);
        },
    };

    let Pong = Object.assign({}, Game);
    Pong.initialize();

    /** here we add an event source and send data to our server*/
    // this is our event source it needs the address of our server
    const server = new EventSource("demo");

    server.addEventListener("message", function (event) {
        console.log(event);
    });

    server.addEventListener("HELLO", function (event) {
        console.log(event);
        sendData('HELLO',1);
    });

    server.addEventListener("new_player", function (event) {
        addPlayer(event);
    });

    function addPlayer(player) {

    }

    function sendData(event, data) {
        fetch('/data/' + event,
            {
                method: 'PUT',
                body: data
            }
        ).then(function(response){
            console.log(response)
        }).catch(function(err){
            console.log(err)
        });
    }
</script>
</body>
</html>